#!/bin/bash
#
# /root/bin/rsync.selftest
#
##############################################################
# MANAGED BY PUPPET. DO NOT EDIT. CHANGES WILL BE WIPED OUT. #
##############################################################
#
# Use as quick test rsync daemon.
#
HOSTNAME=`hostname`
PROG=$(basename $0)
LOGGER=/usr/bin/logger
RSYNC=/usr/bin/rsync
ECHO=/bin/echo

###############################
# MAIN PROGRAM
###############################

if [[ $EUID -ne 0 ]] ;then
   $ECHO "$PROG: This script must be run as root" 
   exit 0
fi

$ECHO -n "Please enter the remote RSYNC USER: "
read rsyncuser

if [ -z "$rsyncuser" ]; then
    $ECHO "Did not get any answer - aborting now."
    exit 1
else

    # start with some information
    
    echo "This script will test the connection to the rsync server by listing the"
    echo "remote files , or it will rsync all files in user home directory to the server."
    echo -n "Enter \"test\" or \"sync\" [t/s] "
    read answer
    
    case "$answer" in
            [Tt])
                
                $RSYNC $rsyncuser@<%= rsyncsrvaddress %>::${HOSTNAME}-home-${rsyncuser}
                returncode=$?
                
                if [ "$returncode" -ne 0 ]; then
                    $ECHO "$0: ERROR: rsync returned ($returncode) when login for user ($rsyncuser) to (${HOSTNAME}-home-${rsyncuser})."
                    $LOGGER -p local0.debug "$0: ERROR: rsync returned ($returncode) when login for user ($rsyncuser) to (${HOSTNAME}-home-${rsyncuser})"
                else
                    $ECHO "$0: Successful remote file listing for user ($rsyncuser) from (${HOSTNAME}-home-${rsyncuser})."
                    $LOGGER -p local0.debug "$0: Successful remote file listing for user ($rsyncuser) from (${HOSTNAME}-home-${rsyncuser})."
                fi
                
                ;;
    
            [Ss])
            
                OPTIONS_FILE="/home/${rsyncuser}/bin/${rsyncuser}.backup"
                OPTIONS="-avhWC --progress --stats"
                IPSRVADDR="<%= rsyncsrvaddress %>"
                SRC_DIRECTORIES=/home/${rsyncuser}/
                DEFAULT_EXCLUDES="--exclude=nfs/"
                
                # Source the user configuration file
                if [ -r "$OPTIONS_FILE" ]; then
                   .  "$OPTIONS_FILE"
                fi
                
                $RSYNC $OPTIONS $DEFAULT_EXCLUDES $USER_EXCLUDES $SRC_DIRECTORIES ${rsyncuser}@${IPSRVADDR}::${HOSTNAME}-home-${rsyncuser}
                
                remotesuccess=$?
                if [ "$remotesuccess" -ne 0 ]; then
                    $ECHO
                    $ECHO "$0: ERROR: rsync returned ($returncode) after file transfer to (${HOSTNAME}-home-${rsyncuser})."
                    $LOGGER -p local0.debug "$0: ERROR: rsync returned ($returncode) after file transfer to (${HOSTNAME}-home-${rsyncuser})"
                else
                    $ECHO
                    $ECHO "$0: Successful transfer of files for ($rsyncuser) to (${HOSTNAME}-home-${rsyncuser})."
                    $LOGGER -p local0.debug "$0: Successful transfer of files for ($rsyncuser) to (${HOSTNAME}-home-${rsyncuser})."
                fi
                
                ;;
                
            *)
              echo "Did not get any answer - aborting."
              exit 0
              ;;
                
    esac

fi
exit 0
